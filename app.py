from flask import Flask, request, render_template
import re
import nltk
import pickle
import pandas as pd
from nltk.corpus import stopwords
from nltk.stem import WordNetLemmatizer
from nltk.tokenize import word_tokenize
from model_loader import load_models, predict_with_ensemble

app = Flask(__name__)

# 下載 NLTK 資料
nltk.download('punkt')
nltk.download('wordnet')
nltk.download('stopwords')
nltk.download('omw-1.4')
nltk.download('punkt_tab')

# 初始化工具
stop_words = set(stopwords.words('english'))
lemmatizer = WordNetLemmatizer()

# 載入 TfidfVectorizer
with open('vectorizer.pkl', 'rb') as f:
    vectorizer = pickle.load(f)

# 你的特徵欄位（只保留模型訓練有用到的）
selected_features = ['ability', 'able', 'absolute', 'absolutely', 'abuse', 'abused', 'abuser', 'abusive', 'academic', 'accept', 'accepted', 'access', 'accident', 'accidentally', 'account', 'accurate', 'achieve', 'across', 'act', 'acting', 'action', 'active', 'actively', 'activity', 'actual', 'actually', 'ad', 'add', 'added', 'additional', 'address', 'adhd', 'admit', 'adult', 'advance', 'advice', 'affect', 'affected', 'affection', 'afford', 'afraid', 'afterwards', 'age', 'ago', 'agree', 'ahead', 'ai', 'air', 'airport', 'alcohol', 'algorithm', 'alive', 'allow', 'allowed', 'allows', 'almost', 'alone', 'along', 'alot', 'already', 'alright', 'also', 'alternative', 'although', 'always', 'amazing', 'amazon', 'america', 'american', 'amount', 'amp', 'ampxb', 'analysis', 'analyst', 'analytics', 'analyze', 'analyzing', 'andor', 'anger', 'angry', 'animal', 'annotated', 'annoying', 'annual', 'another', 'answer', 'antidepressant', 'anxiety', 'anxious', 'anybody', 'anymore', 'anyone', 'anything', 'anytime', 'anyway', 'anyways', 'anywhere', 'apart', 'apartment', 'api', 'apis', 'app', 'apparently', 'application', 'apply', 'appointment', 'appreciate', 'appreciated', 'approach', 'apps', 'archive', 'area', 'arent', 'argument', 'arm', 'around', 'art', 'article', 'artist', 'as', 'ashamed', 'aside', 'ask', 'asked', 'asking', 'asks', 'asleep', 'aspect', 'assaulted', 'asshole', 'assignment', 'associated', 'assume', 'attached', 'attack', 'attempt', 'attempted', 'attention', 'attribute', 'audio', 'author', 'automatically', 'available', 'average', 'avoid', 'awake', 'aware', 'away', 'awesome', 'awful', 'awkward', 'baby', 'back', 'background', 'bad', 'badly', 'bank', 'bar', 'barely', 'base', 'based', 'basic', 'basically', 'basis', 'bathroom', 'battle', 'bc', 'bear', 'beat', 'beating', 'beautiful', 'became', 'become', 'becomes', 'becoming', 'bed', 'bedroom', 'began', 'begin', 'beginning', 'behavior', 'behind', 'belief', 'believe', 'belong', 'benefit', 'besides', 'best', 'better', 'beyond', 'bf', 'big', 'biggest', 'bigquery', 'bill', 'billion', 'birth', 'birthday', 'bit', 'bitch', 'black', 'blame', 'blank', 'block', 'blocked', 'blog', 'blood', 'body', 'bonus', 'book', 'bored', 'boring', 'born', 'bother', 'bothered', 'bottom', 'bought', 'boundary', 'box', 'boy', 'boyfriend', 'brain', 'brand', 'break', 'breakdown', 'breaking', 'breakup', 'breathe', 'bridge', 'bring', 'bringing', 'brings', 'broke', 'broken', 'brother', 'brought', 'brush', 'build', 'building', 'built', 'bulk', 'bullshit', 'bunch', 'burden', 'business', 'busy', 'buy', 'buying', 'california', 'call', 'called', 'calling', 'calm', 'came', 'can', 'canada', 'cancer', 'cant', 'capable', 'car', 'card', 'care', 'cared', 'career', 'caring', 'carry', 'case', 'cat', 'category', 'caught', 'cause', 'caused', 'causing', 'census', 'center', 'certain', 'certainly', 'chain', 'challenge', 'chance', 'change', 'changed', 'changing', 'channel', 'character', 'charge', 'chart', 'chat', 'cheated', 'check', 'checked', 'checking', 'cheer', 'chest', 'child', 'childhood', 'choice', 'choose', 'chore', 'chose', 'christmas', 'chronic', 'city', 'claim', 'class', 'classification', 'clean', 'cleaning', 'clear', 'clearly', 'click', 'climate', 'close', 'closed', 'closer', 'closest', 'clothes', 'cloud', 'code', 'coffee', 'cold', 'collect', 'collected', 'collecting', 'collection', 'college', 'color', 'column', 'come', 'comfort', 'comfortable', 'comforting', 'coming', 'comment', 'commercial', 'commit', 'committed', 'common', 'communicate', 'communication', 'community', 'company', 'compare', 'compared', 'comparing', 'comparison', 'competition', 'complain', 'complete', 'completely', 'complex', 'complicated', 'comprehensive', 'computer', 'concerned', 'condition', 'confidence', 'confident', 'confused', 'connect', 'connected', 'connection', 'consider', 'considered', 'considering', 'constant', 'constantly', 'consumer', 'consumption', 'contact', 'contain', 'containing', 'contains', 'content', 'context', 'continue', 'continues', 'control', 'conversation', 'convince', 'cool', 'coordinate', 'cop', 'cope', 'coping', 'copy', 'corner', 'coronavirus', 'corpus', 'correct', 'correlation', 'corresponding', 'cost', 'could', 'couldnt', 'count', 'country', 'county', 'couple', 'courage', 'course', 'court', 'cover', 'covid', 'coward', 'coworkers', 'crap', 'crazy', 'create', 'created', 'creating', 'credit', 'cried', 'crime', 'crisis', 'cross', 'cruel', 'cry', 'csv', 'cuddle', 'curious', 'current', 'currently', 'customer', 'cut', 'cutting', 'cuz', 'cycle', 'dad', 'daily', 'damage', 'damn', 'dark', 'dashboard', 'data', 'database', 'dataset', 'datasets', 'date', 'dating', 'daughter', 'day', 'dead', 'deal', 'dealing', 'dealt', 'death', 'debt', 'decade', 'decent', 'decide', 'decided', 'decision', 'deep', 'definitely', 'degree', 'deleted', 'demand', 'demographic', 'department', 'depressed', 'depressing', 'depression', 'depressive', 'describe', 'description', 'deserve', 'desire', 'desperate', 'desperately', 'despite', 'destroyed', 'detail', 'detailed', 'detection', 'develop', 'developed', 'developer', 'developing', 'development', 'device', 'diagnosed', 'diagnosis', 'didnt', 'die', 'died', 'difference', 'different', 'difficult', 'digital', 'dinner', 'direct', 'direction', 'directly', 'dirty', 'disabled', 'disappear', 'disappointed', 'disappointment', 'disconnected', 'discord', 'discus', 'discussion', 'disease', 'disgusting', 'disorder', 'distance', 'distant', 'distract', 'distribution', 'divorce', 'divorced', 'dm', 'doctor', 'document', 'doesnt', 'dog', 'dollar', 'domain', 'done', 'dont', 'door', 'doubt', 'download', 'downloaded', 'downloading', 'drained', 'dread', 'dream', 'drink', 'drinking', 'drive', 'driving', 'drop', 'dropped', 'drug', 'drunk', 'dude', 'due', 'dumb', 'dump', 'dying', 'earlier', 'early', 'earth', 'easier', 'easily', 'easy', 'eat', 'eating', 'ecommerce', 'economic', 'economics', 'edge', 'edit', 'education', 'effect', 'effort', 'eg', 'either', 'el', 'election', 'else', 'email', 'embarrassed', 'emotion', 'emotional', 'emotionally', 'employee', 'emptiness', 'empty', 'end', 'ended', 'ending', 'endless', 'energy', 'engine', 'english', 'enjoy', 'enough', 'entire', 'entirely', 'entity', 'entry', 'environment', 'episode', 'escape', 'especially', 'essentially', 'estate', 'estimate', 'etc', 'europe', 'european', 'even', 'evening', 'event', 'eventually', 'ever', 'every', 'everybody', 'everyday', 'everyone', 'everyones', 'everything', 'everytime', 'everywhere', 'ex', 'exactly', 'example', 'excel', 'except', 'exchange', 'excited', 'excuse', 'exercise', 'exhausted', 'exhausting', 'exist', 'existence', 'existing', 'exists', 'expect', 'expected', 'expecting', 'expensive', 'experience', 'experienced', 'experiencing', 'expert', 'explain', 'explore', 'express', 'extra', 'extract', 'extreme', 'extremely', 'eye', 'face', 'facebook', 'fact', 'factor', 'fail', 'failed', 'failing', 'failure', 'fair', 'fairly', 'fake', 'fall', 'falling', 'familiar', 'family', 'far', 'fast', 'father', 'fault', 'favorite', 'fear', 'feature', 'federal', 'feed', 'feedback', 'feel', 'feeling', 'fell', 'felt', 'female', 'field', 'fight', 'fighting', 'figure', 'figured', 'file', 'fill', 'filled', 'filter', 'final', 'finally', 'finance', 'financial', 'find', 'finding', 'fine', 'finish', 'finished', 'fire', 'firm', 'first', 'fit', 'five', 'fix', 'fixed', 'flashback', 'flat', 'flight', 'floor', 'focus', 'focused', 'folk', 'follow', 'followed', 'following', 'food', 'foot', 'football', 'force', 'forced', 'forever', 'forget', 'forgot', 'forgotten', 'form', 'format', 'forum', 'forward', 'found', 'four', 'freaking', 'free', 'friend', 'friendly', 'friendship', 'front', 'frustrated', 'frustrating', 'fuck', 'fucked', 'fucking', 'full', 'fully', 'fun', 'function', 'funny', 'future', 'gain', 'game', 'gather', 'gave', 'gb', 'gender', 'general', 'generally', 'generate', 'genre', 'genuine', 'genuinely', 'germany', 'get', 'getting', 'gf', 'ghost', 'gift', 'girl', 'girlfriend', 'github', 'give', 'given', 'giving', 'glad', 'global', 'go', 'goal', 'god', 'going', 'gon', 'gone', 'good', 'goodbye', 'google', 'got', 'gotten', 'government', 'grab', 'grade', 'graduate', 'graph', 'grateful', 'great', 'greatly', 'grief', 'grocery', 'ground', 'group', 'grow', 'growing', 'grown', 'gt', 'guess', 'guide', 'guilt', 'guilty', 'gun', 'gut', 'guy', 'gym', 'habit', 'hair', 'half', 'hand', 'handle', 'hang', 'hanging', 'happen', 'happened', 'happening', 'happens', 'happier', 'happiness', 'happy', 'hard', 'harder', 'hardest', 'hardly', 'harm', 'hasnt', 'hate', 'hated', 'havent', 'he', 'head', 'heal', 'health', 'healthcare', 'healthy', 'hear', 'heard', 'hearing', 'heart', 'heavy', 'height', 'held', 'hell', 'hello', 'help', 'helped', 'helpful', 'helping', 'here', 'hey', 'hi', 'hide', 'high', 'higher', 'highly', 'historical', 'history', 'hit', 'hitting', 'hobby', 'hold', 'holding', 'hole', 'holiday', 'home', 'homeless', 'honest', 'honestly', 'hope', 'hopefully', 'hopeless', 'hoping', 'horrible', 'hospital', 'hotline', 'hour', 'house', 'household', 'housing', 'however', 'hug', 'huge', 'human', 'hundred', 'hurt', 'hurting', 'husband', 'hygiene', 'id.1', 'idea', 'ideal', 'ideally', 'ideation', 'identify', 'idiot', 'idk', 'ie', 'ignore', 'ignored', 'ignoring', 'ill', 'illness', 'im', 'image', 'imagine', 'immediately', 'impact', 'important', 'impossible', 'improve', 'include', 'included', 'includes', 'including', 'income', 'increase', 'incredibly', 'index', 'india', 'indian', 'individual', 'industry', 'info', 'information', 'injury', 'inner', 'input', 'insane', 'inside', 'insight', 'instagram', 'instance', 'instead', 'insult', 'insurance', 'intelligence', 'interact', 'interaction', 'interest', 'interested', 'interesting', 'international', 'internet', 'interview', 'invited', 'involved', 'isnt', 'isolated', 'isolating', 'isolation', 'issue', 'itd', 'item', 'itll', 'ive', 'january', 'jealous', 'job', 'join', 'joke', 'joy', 'json', 'judge', 'july', 'jump', 'kaggle', 'keep', 'keeping', 'kept', 'key', 'kick', 'kicked', 'kid', 'kill', 'killed', 'killing', 'kind', 'kinda', 'km', 'knew', 'knife', 'know', 'knowing', 'knowledge', 'known', 'label', 'labeled', 'labelled', 'labor', 'lack', 'land', 'language', 'large', 'largest', 'last', 'late', 'lately', 'later', 'latest', 'laugh', 'laughed', 'law', 'lay', 'laying', 'lazy', 'le', 'lead', 'leaf', 'league', 'learn', 'learned', 'learning', 'least', 'leave', 'leaving', 'left', 'leg', 'legal', 'let', 'letter', 'letting', 'level', 'library', 'license', 'lie', 'lied', 'life', 'light', 'like', 'liked', 'likely', 'limit', 'limited', 'line', 'link', 'linked', 'linkedin', 'list', 'listed', 'listen', 'listening', 'literally', 'little', 'live', 'lived', 'living', 'load', 'local', 'location', 'log', 'lol', 'loneliness', 'lonely', 'long', 'longer', 'look', 'looked', 'looking', 'lose', 'loser', 'losing', 'loss', 'lost', 'lot', 'loud', 'love', 'loved', 'loving', 'low', 'lower', 'luck', 'lucky', 'lunch', 'lying', 'machine', 'mad', 'made', 'main', 'mainly', 'major', 'majority', 'make', 'making', 'male', 'man', 'manage', 'managed', 'management', 'manually', 'many', 'map', 'march', 'mark', 'market', 'marketing', 'marriage', 'married', 'mask', 'massive', 'master', 'match', 'math', 'matter', 'may', 'maybe', 'mean', 'meaning', 'meaningful', 'meaningless', 'meant', 'measure', 'med', 'median', 'medical', 'medication', 'medicine', 'medium', 'meet', 'meeting', 'member', 'memory', 'men', 'mental', 'mentally', 'mention', 'mentioned', 'mess', 'message', 'messed', 'met', 'metadata', 'method', 'metric', 'middle', 'might', 'military', 'million', 'min', 'mind', 'mine', 'minimum', 'mining', 'minor', 'minute', 'mirror', 'miserable', 'misery', 'miss', 'missed', 'missing', 'mistake', 'ml', 'model', 'mom', 'moment', 'money', 'monster', 'month', 'monthly', 'mood', 'morning', 'mortality', 'mostly', 'mother', 'motivated', 'motivation', 'mouth', 'move', 'moved', 'movie', 'moving', 'much', 'multiple', 'mum', 'music', 'must', 'na', 'name', 'national', 'natural', 'nature', 'nba', 'near', 'nearly', 'necessary', 'need', 'needed', 'negative', 'nervous', 'net', 'network', 'never', 'new', 'news', 'next', 'nfl', 'nice', 'night', 'nightmare', 'nlp', 'nobody', 'noise', 'non', 'none', 'normal', 'normally', 'not', 'note', 'nothing', 'notice', 'noticed', 'nowhere', 'numb', 'number', 'nyc', 'object', 'obtain', 'obvious', 'obviously', 'offer', 'office', 'official', 'often', 'oh', 'ok', 'okay', 'old', 'older', 'one', 'online', 'onto', 'open', 'opened', 'opening', 'opinion', 'opportunity', 'opposite', 'option', 'order', 'organization', 'original', 'others', 'otherwise', 'outcome', 'outside', 'overall', 'overcome', 'overwhelmed', 'overwhelming', 'package', 'page', 'paid', 'pain', 'painful', 'pandemic', 'panic', 'paper', 'parent', 'part', 'particular', 'particularly', 'partner', 'party', 'pas', 'passed', 'passion', 'past', 'path', 'pathetic', 'patient', 'pattern', 'pay', 'paying', 'peace', 'peaceful', 'people', 'per', 'percentage', 'perfect', 'perform', 'performance', 'perhaps', 'period', 'permanent', 'person', 'personal', 'personality', 'personally', 'perspective', 'pet', 'phase', 'phone', 'photo', 'physical', 'physically', 'pick', 'picked', 'picture', 'piece', 'pill', 'pissed', 'pit', 'place', 'plan', 'planet', 'planned', 'planning', 'plant', 'platform', 'play', 'played', 'player', 'playing', 'please', 'plus', 'pm', 'point', 'pointless', 'police', 'political', 'poor', 'popular', 'population', 'position', 'positive', 'possible', 'possibly', 'post', 'posted', 'posting', 'potential', 'potentially', 'power', 'ppl', 'practice', 'predict', 'predicting', 'prediction', 'prefer', 'preferably', 'preference', 'present', 'pressure', 'pretend', 'pretending', 'pretty', 'previous', 'previously', 'price', 'private', 'pro', 'probably', 'problem', 'process', 'processing', 'product', 'production', 'productive', 'professional', 'profile', 'program', 'programming', 'progress', 'project', 'promise', 'proper', 'properly', 'property', 'proud', 'provide', 'provided', 'provider', 'provides', 'providing', 'psych', 'psychiatrist', 'ptsd', 'public', 'publicly', 'published', 'pull', 'pulled', 'purchase', 'purpose', 'push', 'pushed', 'pushing', 'put', 'putting', 'python', 'quality', 'quarantine', 'query', 'question', 'quick', 'quickly', 'quiet', 'quit', 'quite', 'quote', 'race', 'racism', 'racist', 'ran', 'random', 'randomly', 'range', 'rant', 'raped', 'rarely', 'rate', 'rather', 'rating', 'ratio', 'raw', 'rdatasets', 'reach', 'reached', 'reaching', 'reaction', 'read', 'reading', 'ready', 'real', 'realise', 'realised', 'reality', 'realize', 'realized', 'realizing', 'really', 'reason', 'receive', 'received', 'recent', 'recently', 'recognition', 'recommend', 'recommendation', 'record', 'recovery', 'red', 'reddit', 'reference', 'refuse', 'regard', 'regarding', 'regardless', 'region', 'regression', 'regret', 'regular', 'regularly', 'rejected', 'relate', 'related', 'relationship', 'release', 'released', 'relevant', 'reliable', 'relief', 'remember', 'remind', 'removed', 'rent', 'repeat', 'reply', 'report', 'repository', 'request', 'require', 'required', 'requires', 'research', 'researcher', 'resource', 'respect', 'respond', 'response', 'responsibility', 'rest', 'restaurant', 'result', 'retail', 'return', 'revenue', 'review', 'rid', 'ride', 'right', 'risk', 'rn', 'road', 'rock', 'role', 'romantic', 'room', 'roommate', 'rot', 'rough', 'routine', 'row', 'rude', 'ruin', 'ruined', 'rule', 'run', 'running', 'sad', 'sadness', 'safe', 'safety', 'said', 'sake', 'salary', 'sale', 'sample', 'sat', 'save', 'saved', 'saw', 'say', 'saying', 'scale', 'scare', 'scared', 'scary', 'scenario', 'schedule', 'school', 'science', 'scientist', 'score', 'scrape', 'scraped', 'scraping', 'scream', 'screaming', 'screen', 'script', 'search', 'searched', 'searching', 'season', 'second', 'sector', 'security', 'see', 'seeing', 'seek', 'seeking', 'seem', 'seemed', 'seems', 'seen', 'self', 'selfish', 'selfpromotion', 'sell', 'semester', 'send', 'sending', 'sense', 'sensitive', 'sent', 'sentence', 'sentiment', 'separate', 'separated', 'series', 'serious', 'seriously', 'server', 'service', 'session', 'set', 'setting', 'several', 'severe', 'severely', 'sex', 'sexual', 'sexually', 'shake', 'shame', 'share', 'shared', 'sharing', 'sheet', 'shell', 'shes', 'shit', 'shitty', 'shoot', 'shooting', 'shop', 'short', 'shot', 'shoulder', 'shouldnt', 'show', 'showed', 'shower', 'showing', 'shut', 'shy', 'sibling', 'sick', 'side', 'sign', 'significant', 'silence', 'similar', 'simple', 'simply', 'since', 'single', 'sister', 'sit', 'site', 'sitting', 'situation', 'size', 'skill', 'skin', 'sleep', 'sleeping', 'slept', 'slow', 'slowly', 'small', 'smart', 'smile', 'smoking', 'snap', 'social', 'socially', 'society', 'software', 'sold', 'solution', 'solve', 'somebody', 'somehow', 'someone', 'something', 'sometimes', 'somewhat', 'somewhere', 'son', 'song', 'soon', 'sorry', 'sort', 'soul', 'sound', 'source', 'south', 'space', 'speak', 'speaking', 'special', 'specific', 'specifically', 'speech', 'speed', 'spend', 'spending', 'spent', 'sport', 'spot', 'spouse', 'spread', 'spreadsheet', 'sql', 'st', 'stable', 'stage', 'stand', 'standard', 'staring', 'start', 'started', 'starting', 'startup', 'state', 'statistic', 'statistical', 'stats', 'status', 'stay', 'stayed', 'staying', 'step', 'stick', 'still', 'stock', 'stomach', 'stop', 'stopped', 'store', 'story', 'straight', 'strange', 'stranger', 'street', 'strength', 'stress', 'stressed', 'strong', 'stronger', 'structure', 'struggle', 'struggled', 'struggling', 'stuck', 'student', 'study', 'studying', 'stuff', 'stupid', 'sub', 'subject', 'subreddit', 'subreddits', 'success', 'successful', 'suck', 'sudden', 'suddenly', 'suffer', 'suffered', 'suffering', 'suggest', 'suggested', 'suggestion', 'suicidal', 'suicide', 'summer', 'super', 'support', 'supporting', 'supportive', 'suppose', 'supposed', 'sure', 'surrounded', 'survey', 'survive', 'survived', 'swear', 'sweet', 'symptom', 'system', 'table', 'tableau', 'take', 'taken', 'taking', 'talk', 'talked', 'talking', 'task', 'tax', 'tbh', 'teacher', 'team', 'tear', 'technology', 'teenager', 'teeth', 'tell', 'telling', 'temperature', 'temporary', 'ten', 'tend', 'term', 'terrible', 'terrified', 'test', 'testing', 'text.1', 'texted', 'th', 'thank', 'thankful', 'thanks', 'thats', 'therapist', 'therapy', 'there', 'thesis', 'theyd', 'theyll', 'theyre', 'theyve', 'thing', 'think', 'thinking', 'third', 'tho', 'though', 'thought', 'thousand', 'thread', 'threatened', 'three', 'threw', 'throughout', 'throw', 'throwing', 'thrown', 'ticket', 'till', 'time', 'tiny', 'tip', 'tired', 'tiring', 'title', 'today', 'together', 'told', 'tomorrow', 'ton', 'tonight', 'took', 'tool', 'top', 'topic', 'total', 'totally', 'touch', 'tough', 'towards', 'town', 'toxic', 'track', 'tracking', 'traffic', 'train', 'training', 'transcript', 'trapped', 'trash', 'trauma', 'traumatic', 'travel', 'treat', 'treated', 'treatment', 'trend', 'tried', 'trigger', 'triggered', 'trip', 'trouble', 'true', 'truly', 'trust', 'truth', 'try', 'trying', 'turn', 'turned', 'turning', 'tv', 'tw', 'tweet', 'twice', 'twitter', 'two', 'type', 'ugly', 'uk', 'unable', 'unbearable', 'uncomfortable', 'understand', 'understanding', 'understands', 'unfortunately', 'unhappy', 'unhealthy', 'uni', 'unique', 'unit', 'united', 'university', 'unless', 'update', 'updated', 'upon', 'upset', 'urge', 'url', 'us', 'usa', 'usage', 'use', 'used', 'useful', 'useless', 'user', 'using', 'usual', 'usually', 'valid', 'value', 'variable', 'various', 'vehicle', 'vent', 'venting', 'version', 'via', 'victim', 'video', 'view', 'violence', 'violent', 'virus', 'visit', 'visualisation', 'visualization', 'voice', 'void', 'volume', 'vote', 'vulnerable', 'wait', 'waiting', 'wake', 'waking', 'walk', 'walked', 'walking', 'wall', 'wan', 'want', 'wanted', 'wanting', 'war', 'ward', 'warning', 'wasnt', 'waste', 'wasting', 'watch', 'watched', 'watching', 'water', 'wave', 'way', 'weak', 'wear', 'weather', 'web', 'website', 'wed', 'weed', 'week', 'weekend', 'weekly', 'weight', 'weird', 'welcome', 'well', 'went', 'werent', 'weve', 'whatever', 'whats', 'whenever', 'whether', 'white', 'who', 'whole', 'wife', 'wikipedia', 'willing', 'win', 'wish', 'wished', 'wishing', 'within', 'without', 'woke', 'woman', 'wonder', 'wonderful', 'wondering', 'wont', 'word', 'work', 'worked', 'worker', 'working', 'world', 'worldwide', 'worried', 'worry', 'worse', 'worst', 'worth', 'worthless', 'would', 'wouldnt', 'wow', 'write', 'writing', 'written', 'wrong', 'wrote', 'wtf', 'xb', 'yall', 'yeah', 'year', 'yell', 'yelled', 'yes', 'yesterday', 'yet', 'yo', 'york', 'youd', 'youll', 'young', 'younger', 'youre', 'youtube', 'youve', 'yr', 'zero', 'zip', 'zone']

def clean_text(text):
    text = text.lower()
    text = re.sub(r'http\S+|www\S+', '', text)
    text = re.sub(r'\d+', '', text)
    text = re.sub(r'[^\w\s]', '', text)
    text = re.sub(r'\s+', ' ', text).strip()
    text = ' '.join([word for word in text.split() if word not in stop_words])
    return text

def lemmatize_text(text):
    words = word_tokenize(text)
    return ' '.join([lemmatizer.lemmatize(word) for word in words])

def is_english(text):
    return bool(re.match(r'^[a-zA-Z\s]*$', text))

@app.route('/', methods=['GET', 'POST'])
def index():
    result = None
    if request.method == 'POST':
        raw_text = request.form['text']
        clean = clean_text(raw_text)
        if not is_english(clean):
            result = "請輸入英文內容。"
        else:
            lemmatized = lemmatize_text(clean)
            tfidf_vector = vectorizer.transform([lemmatized])
            tfidf_df = pd.DataFrame(tfidf_vector.toarray(), columns=vectorizer.get_feature_names_out())
            tfidf_df = tfidf_df.reindex(columns=selected_features, fill_value=0)
            result = predict_with_ensemble(tfidf_df)

    return render_template('index.html', result=result)

if __name__ == "__main__":
    app.run(debug=True)